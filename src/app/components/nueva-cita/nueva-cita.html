<div class="nueva-cita-container fade-in">
  
  <div class="header-section mb-4">
    <button mat-button routerLink="/dashboard/citas" class="back-btn mb-2">
      <mat-icon>arrow_back</mat-icon> Volver a Citas
    </button>
    <h1 class="main-title">{{ isEditMode ? 'GESTIÓN DE CITA' : 'NUEVA CITA' }}</h1>
  </div>

  <mat-card class="form-card">
    <mat-card-content class="p-4">
      
      <form [formGroup]="citaForm" (ngSubmit)="onSubmit()">
        
        <h3 class="section-title">Datos Generales</h3>
        <div class="row">
          <div class="col-md-6">
            <mat-form-field appearance="outline" class="w-100 custom-field">
              <mat-label>Cliente</mat-label>
              <mat-select formControlName="id_cliente">
                <mat-option *ngFor="let c of clientes" [value]="c.id">{{c.nombre}} {{c.apellido}}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
          <div class="col-md-6">
            <mat-form-field appearance="outline" class="w-100 custom-field">
              <mat-label>Artista</mat-label>
              <mat-select formControlName="id_artista">
                <mat-option *ngFor="let a of artistas" [value]="a.id">{{a.nombre_usuario}}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>

        <div class="row">
          <div class="col-md-4">
            <mat-form-field appearance="outline" class="w-100 custom-field">
              <mat-label>Fecha</mat-label>
              <input matInput [matDatepicker]="picker" formControlName="fecha">
              <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
            </mat-form-field>
          </div>
          <div class="col-md-4">
            <mat-form-field appearance="outline" class="w-100 custom-field">
              <mat-label>Hora</mat-label>
              <input matInput type="time" formControlName="hora">
            </mat-form-field>
          </div>
          
          <div class="col-md-4">
            <mat-form-field appearance="outline" class="w-100 custom-field">
              <mat-label>Estado Actual</mat-label>
              <mat-select formControlName="estado">
                <mat-option *ngFor="let est of estadosCita" [value]="est" class="uppercase-option">
                  {{ est | uppercase }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>

        <mat-divider class="my-4"></mat-divider>

        <div *ngIf="citaForm.get('estado')?.value === 'confirmada'" class="animate-section">
          <h3 class="section-title text-success"><mat-icon>brush</mat-icon> Detalles del Diseño</h3>
          <div class="row">
            <div class="col-md-6">
              <mat-form-field appearance="outline" class="w-100 custom-field">
                <mat-label>Categoría del Diseño</mat-label>
                <mat-select formControlName="id_categoria_diseno">
                  <mat-option *ngFor="let cat of categoriasDiseno" [value]="cat.id">{{cat.nombre}}</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <div class="col-md-4">
              <mat-form-field appearance="outline" class="w-100 custom-field">
                <mat-label>ID Diseño / Referencia</mat-label>
                <input matInput formControlName="id_diseno" placeholder="Opcional">
              </mat-form-field>
            </div>
            <div class="col-md-2">
              <mat-form-field appearance="outline" class="w-100 custom-field">
                <mat-label>Cant.</mat-label>
                <input matInput type="number" formControlName="cantidad_diseno">
              </mat-form-field>
            </div>
          </div>
        </div>

        <div *ngIf="citaForm.get('estado')?.value === 'en_progreso'" class="animate-section">
          <h3 class="section-title text-warning"><mat-icon>inventory_2</mat-icon> Configuración de Sesión</h3>
          
          <div class="row">
            <div class="col-md-6">
              <mat-form-field appearance="outline" class="w-100 custom-field">
                <mat-label>Duración Estimada (min)</mat-label>
                <input matInput type="number" formControlName="duracion_estimada_minutos">
              </mat-form-field>
            </div>
            <div class="col-md-6">
              <mat-form-field appearance="outline" class="w-100 custom-field">
                <mat-label>Costo Total ($)</mat-label>
                <input matInput type="number" formControlName="total_estimado">
                <mat-icon matPrefix>attach_money</mat-icon>
              </mat-form-field>
            </div>
          </div>

          <div class="materiales-box mt-3">
            <h4 class="mb-3">Selección de Materiales</h4>
            <div class="d-flex gap-2 align-items-center">
              <mat-form-field appearance="outline" class="flex-grow-1 custom-field">
                <mat-label>Material de Inventario</mat-label>
                <mat-select [formControl]="materialControl">
                  <mat-option *ngFor="let mat of listaMateriales" [value]="mat.id">
                    {{mat.codigo}} - {{mat.nombre}} (Disp: {{mat.cantidad_existencia}})
                  </mat-option>
                </mat-select>
              </mat-form-field>
              
              <mat-form-field appearance="outline" style="width: 100px;" class="custom-field">
                <mat-label>Cant.</mat-label>
                <input matInput type="number" [formControl]="cantidadMaterialControl" min="1">
              </mat-form-field>

              <button mat-mini-fab color="primary" type="button" (click)="agregarMaterial()" [disabled]="!materialControl.value">
                <mat-icon>add</mat-icon>
              </button>
            </div>

            <mat-list role="list" class="material-list">
              <mat-list-item *ngFor="let item of materialesSeleccionados; let i = index" role="listitem">
                <div class="d-flex justify-content-between w-100 align-items-center">
                  <span>{{item.nombre}} (x{{item.cantidad}})</span>
                  <button mat-icon-button color="warn" type="button" (click)="eliminarMaterial(i)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </mat-list-item>
              <div *ngIf="materialesSeleccionados.length === 0" class="text-muted fst-italic p-2">
                No hay materiales seleccionados para esta sesión.
              </div>
            </mat-list>
          </div>
        </div>

        <div *ngIf="citaForm.get('estado')?.value === 'completada'" class="animate-section">
          <h3 class="section-title text-primary"><mat-icon>done_all</mat-icon> Cierre de Cita</h3>
          <div class="row">
            <div class="col-md-6">
              <mat-form-field appearance="outline" class="w-100 custom-field">
                <mat-label>Duración Final Real (min)</mat-label>
                <input matInput type="number" formControlName="duracion_estimada_minutos">
              </mat-form-field>
            </div>
            <div class="col-md-6">
              <mat-form-field appearance="outline" class="w-100 custom-field">
                <mat-label>Monto Final Cobrado ($)</mat-label>
                <input matInput type="number" formControlName="total_estimado">
                <mat-icon matPrefix>attach_money</mat-icon>
              </mat-form-field>
            </div>
          </div>
        </div>

        <mat-divider class="my-4"></mat-divider>

        <h3 class="section-title">
          <mat-icon>notes</mat-icon> Notas Adicionales
        </h3>
        <mat-form-field appearance="outline" class="w-100 custom-field">
          <mat-label>Observaciones, comentarios o instrucciones especiales</mat-label>
          <textarea matInput formControlName="notas" rows="4" placeholder="Escriba aquí cualquier información adicional relevante..."></textarea>
          <mat-icon matPrefix>description</mat-icon>
        </mat-form-field>

        <!-- Resumen del estado del formulario -->
        <div *ngIf="citaForm.invalid" class="alert alert-warning mt-3" role="alert">
          <mat-icon class="align-middle">warning</mat-icon>
          <span class="ms-2">Algunos campos requeridos están incompletos. Por favor, verifique el formulario.</span>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-4">
          <button mat-stroked-button type="button" routerLink="/dashboard/citas" class="cancel-btn">
            <mat-icon>close</mat-icon> CANCELAR
          </button>
          <button mat-flat-button class="save-btn py-4 px-5" [disabled]="citaForm.invalid || isSubmitting">
            <mat-icon class="me-2">{{ isSubmitting ? 'hourglass_empty' : 'save' }}</mat-icon>
            {{ isSubmitting ? 'PROCESANDO...' : (isEditMode ? 'ACTUALIZAR CITA' : 'CREAR CITA') }}
          </button>
        </div>

      </form>
    </mat-card-content>
  </mat-card>
</div>