<div class="sesiones-container fade-in">
  
  <div class="section-header">
    <h1>Control Operativo</h1>
    <span class="subtitle">Monitoreo de sesiones y consumo de recursos</span>
  </div>

  <mat-card class="custom-card mb-4">
    <mat-card-header>
      <mat-card-title class="text-coffee mb-3">Gesti贸n de Sesiones</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      
      <form [formGroup]="filterForm" (ngSubmit)="buscarSesiones()">
        <div class="row align-items-center">
          
          <div class="col-md-2">
            <mat-form-field appearance="outline" class="w-100 custom-form-field">
              <mat-label>ID Cita</mat-label>
              <input matInput type="number" formControlName="id_cita" placeholder="#">
            </mat-form-field>
          </div>

          <div class="col-md-3">
            <mat-form-field appearance="outline" class="w-100 custom-form-field">
              <mat-label>Estado</mat-label>
              <mat-select formControlName="estado">
                <mat-option value="">Todos</mat-option>
                <mat-option *ngFor="let estado of estadosSesion" [value]="estado">
                  {{ estado | uppercase }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="col-md-3">
            <mat-form-field appearance="outline" class="w-100 custom-form-field">
              <mat-label>Artista</mat-label>
              <mat-select formControlName="id_artista">
                <mat-option value="">Todos</mat-option>
                <mat-option *ngFor="let artista of artistas" [value]="artista.id">
                  {{ artista.nombre_usuario }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="col-md-3">
            <mat-form-field appearance="outline" class="w-100 custom-form-field">
              <mat-label>Cliente</mat-label>
              <mat-select formControlName="id_cliente">
                <mat-option value="">Todos</mat-option>
                <mat-option *ngFor="let cliente of clientes" [value]="cliente.id">
                  {{ cliente.nombre }} {{ cliente.apellido }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="col-md-1 d-flex justify-content-end gap-2">
            <button mat-icon-button type="submit" color="primary" matTooltip="Buscar Sesiones" class="action-btn">
              <mat-icon>search</mat-icon>
            </button>
            <button mat-icon-button type="button" (click)="limpiarFiltrosSesiones()" color="warn" matTooltip="Limpiar" class="action-btn">
              <mat-icon>restart_alt</mat-icon>
            </button>
          </div>

        </div>
      </form>

      <div class="table-container mat-elevation-z0 mt-3">
        <table mat-table [dataSource]="dataSource" matSort>

          <ng-container matColumnDef="id_sesion">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Sesi贸n # </th>
            <td mat-cell *matCellDef="let row"> #{{row.id_sesion}} ({{row.numero_sesion}}) </td>
          </ng-container>

          <ng-container matColumnDef="cita">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Cita </th>
            <td mat-cell *matCellDef="let row"> #{{row.id_cita}} </td>
          </ng-container>

          <ng-container matColumnDef="cliente">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Cliente </th>
            <td mat-cell *matCellDef="let row" class="fw-bold"> {{row.nombre_cliente}} </td>
          </ng-container>

          <ng-container matColumnDef="artista">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Artista </th>
            <td mat-cell *matCellDef="let row"> {{row.nombre_artista}} </td>
          </ng-container>

          <ng-container matColumnDef="fecha">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Programada </th>
            <td mat-cell *matCellDef="let row"> {{row.fecha_programada | date:'dd/MM/yyyy HH:mm'}} </td>
          </ng-container>

          <ng-container matColumnDef="estado">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Estado </th>
            <td mat-cell *matCellDef="let row"> 
              <span [class]="'badge ' + (row.estado_sesion?.toLowerCase() || 'pendiente')">
                {{row.estado_sesion | uppercase}}
              </span>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell text-center py-4" colspan="6">
              No se encontraron sesiones.
            </td>
          </tr>
        </table>
        <mat-paginator #paginatorSesiones [pageSizeOptions]="[5, 10]" showFirstLastButtons></mat-paginator>
      </div>

    </mat-card-content>
  </mat-card>

  <mat-divider class="my-5"></mat-divider>

  <mat-card class="custom-card mb-4">
    <mat-card-header>
      <div class="d-flex align-items-center gap-2 mb-3">
        <mat-icon class="text-coffee">inventory_2</mat-icon>
        <h2 class="card-title mb-0">Reporte de Materiales Usados</h2>
      </div>
    </mat-card-header>
    <mat-card-content>
      
      <form [formGroup]="materialForm" (ngSubmit)="buscarMateriales()">
        <div class="row align-items-center">
          
          <div class="col-md-4">
            <mat-form-field appearance="outline" class="w-100 custom-form-field">
              <mat-label>Filtrar por ID de Sesi贸n</mat-label>
              <input matInput type="number" formControlName="id_sesion" placeholder="Ej. 150">
              <mat-icon matSuffix>tag</mat-icon>
            </mat-form-field>
          </div>

          <div class="col-md-5">
            <mat-form-field appearance="outline" class="w-100 custom-form-field">
              <mat-label>Filtrar por Material</mat-label>
              <mat-select formControlName="id_material">
                <mat-option value="">-- Todos --</mat-option>
                <mat-option *ngFor="let m of listaMateriales" [value]="m.id">
                  {{ m.codigo }} - {{ m.nombre }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="col-md-3 d-flex justify-content-end gap-2">
            <button mat-flat-button color="primary" class="filter-btn flex-grow-1">
              <mat-icon>search</mat-icon> BUSCAR
            </button>
            <button mat-stroked-button type="button" (click)="limpiarFiltrosMateriales()" class="clear-btn">
              LIMPIAR
            </button>
          </div>

        </div>
      </form>

      <div class="table-container mat-elevation-z0 mt-3">
        <table mat-table [dataSource]="dataSourceMateriales">

          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef> ID </th>
            <td mat-cell *matCellDef="let row"> #{{row.id}} </td>
          </ng-container>

          <ng-container matColumnDef="sesion">
            <th mat-header-cell *matHeaderCellDef> Sesi贸n </th>
            <td mat-cell *matCellDef="let row"> 
              <span class="fw-bold">#{{row.id_sesion}}</span> 
            </td>
          </ng-container>

          <ng-container matColumnDef="material">
            <th mat-header-cell *matHeaderCellDef> Material </th>
            <td mat-cell *matCellDef="let row">
              <div class="d-flex flex-column">
                <span class="fw-bold">{{row.nombre_material}}</span>
                <small class="text-muted">{{row.codigo}}</small>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="cantidad">
            <th mat-header-cell *matHeaderCellDef> Cantidad </th>
            <td mat-cell *matCellDef="let row"> 
              <span class="badge programada">{{row.cantidad_usada}} {{row.unidad}}</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="costo">
            <th mat-header-cell *matHeaderCellDef> Costo U. </th>
            <td mat-cell *matCellDef="let row"> {{row.costo_unitario | currency}} </td>
          </ng-container>

          <ng-container matColumnDef="subtotal">
            <th mat-header-cell *matHeaderCellDef> Subtotal </th>
            <td mat-cell *matCellDef="let row" class="fw-bold text-coffee"> 
              {{row.subtotal | currency}} 
            </td>
          </ng-container>

          <ng-container matColumnDef="notas">
            <th mat-header-cell *matHeaderCellDef> Notas </th>
            <td mat-cell *matCellDef="let row" class="text-muted fst-italic"> 
              {{row.notas || '--'}} 
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumnsMateriales"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumnsMateriales;"></tr>

          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell text-center py-4" colspan="7">
              No hay registros de materiales.
            </td>
          </tr>
        </table>
        <mat-paginator #paginatorMateriales [pageSizeOptions]="[5, 10]" showFirstLastButtons></mat-paginator>
      </div>

    </mat-card-content>
  </mat-card>

</div>